sudo: false

# Caching so the next build will be fast too.
cache:
  directories:
  - $HOME/.ghc
  - $HOME/.stack
  - $HOME/.local/bin
  - $TRAVIS_BUILD_DIR/.stack-work

env: TRAVIS_TAG=0.19.0

matrix:
    include:
        - env: BUILD=linux
          compiler: ": #stack linux"
          language: generic
          addons: {apt: {packages: [libgmp-dev]}}
          deploy:
              provider: releases
              api_key:
                  secure: JIdzMwmQ7nQ8nBew6FqWdM8FC/dAr6i1w5Kj/9VpBNkU761ce6LlO6MMkSiILGLZXkDp32fmTBkOVz4WXQjnyvTcC8mpCOzk/DC9adq0LNxzymDJIsX4QihLc43/SH+H1GKixx5Zrxco+3obOj0lQJfrk+VFjIRwAYbOX5dx/Fwa136dJApIxeeKLClQKJPQTKa5kc/i6/Rp5RLx+aYWRIHhBuDvWBPs4FX+VgIFSjdMC0Qtuc8vJyaMTOG1LqFw+hLG8VfSIt21uQzgk74I+Vkqx1tNzqzHsT2Zp+2ZZlaS9Q+ZHHduQleZ1grVQs/rrCDGjl36pMWsCbjJmD/rruizISFlKlEJQDBhZAt2sq2nbkHriw1jhF1E13ePpLg+eodGJN5CRHUQeWKlb2UFgWb00+mtxEJydQRw88XglUQWMW9LLbgTypKUQplxeGfQe9sniOdvB8LJqnKRwHPvG8VSqOa1dQEB3uLSCYLbb82l9i1y1hlRX1FpaTkYaNR4Oq2BCWNFdUyKXWlLNeNukkmtgWgF023e6FB6eUTUukwJPx8BvTw/E3r+I0O/vEHnfCXnyvAyGwL/u0kPL0qxfhxS2QFVlRN1rmCutVZbri2OG0PLJOGILPqeO3yAiW9OSLzF5i2K7M02a6I+sfKi06Ry24wbPjj9SiT3UtgWajs=
              file: binary-for-linux.tar.gz
              draft: true
              skip_cleanup: true
              on:
                 repo: m-mullins/compiler
                 all_branches: true

        #- env: BUILD=mac
        #  compiler: ": #stack mac"
        #  language: generic
        #  os: osx
        #  deploy:
        #      provider: releases
        #      api_key:
        #          secure: N+OIuVwMA9+2/7Xx/ObYGEa2oNiFv9PCdp+zLplfXpeAfhpoCbmnzPmBh1AlvzDH9743godTrarnbcTwLj+lFeTAtMfU/Y6U+1rl2lCYi5xDuV20Z+KG36m7T+nSkVvWDkHyFNdOQ89rnDrMF0Xc+5TZ0l7tVHzLUbD+/99OKck=
        #      file: binary-for-mac.tar.gz
        #      draft: true
        #      skip_cleanup: true
        #      on:
        #          all_branches: true

        #- env: BUILD=win
        #  compiler: ": #stack windows"
        #  language: bash
        #  os: windows


before_install:
 - |
   set -ex
   case "$BUILD" in
       win)
           choco install haskell-stack
           ;;
       mac)
           travis_retry curl --insecure -L https://get.haskellstack.org/stable/osx-x86_64.tar.gz | tar xz --strip-components=1 --include '*/stack' -C ~/.local/bin
           ;;
       linux)
           travis_retry curl -L https://get.haskellstack.org/stable/linux-x86_64.tar.gz | tar xz --wildcards --strip-components=1 -C ~/.local/bin '*/stack'
           ;;
   esac
   set +ex
    
install:
    - echo ">> trying only-dependencies $BUILD stack=$(which stack)"
    - stack --no-terminal --install-ghc build --only-dependencies

script:
    - echo ">> trying $BUILD stack=$(which stack)"
    - stack --no-terminal build
    - tar zcvf binary-for-$BUILD.tar.gz -C $(stack path --local-install-root)/bin .
    - echo ">> zipped? $(ls -1 *.tar.gz)"
    - echo ">> deploy tag $TRAVIS_TAG"

before_deploy:
    - git config --local user.name "Martin Mullins"
    - git config --local user.email "martin.mullins942@gmail.com"
    - export TRAVIS_TAG=0.19.0
    - git tag -f $TRAVIS_TAG
